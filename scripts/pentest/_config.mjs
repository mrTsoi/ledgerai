import fs from 'node:fs/promises'
import path from 'node:path'

const DEFAULT_CONFIG_PATH = path.resolve('security/pentest/pentest.config.json')

function resolveEnvTemplates(value) {
  if (typeof value === 'string') {
    return value.replace(/\$\{([A-Z0-9_]+)\}/g, (_, name) => process.env[name] ?? '')
  }
  if (Array.isArray(value)) return value.map(resolveEnvTemplates)
  if (value && typeof value === 'object') {
    const out = {}
    for (const [k, v] of Object.entries(value)) out[k] = resolveEnvTemplates(v)
    return out
  }
  return value
}

export async function loadPentestConfig(configPath = DEFAULT_CONFIG_PATH) {
  const raw = await fs.readFile(configPath, 'utf8')
  const parsed = JSON.parse(raw)

  const config = resolveEnvTemplates(parsed)

  if (!config?.target?.baseUrl) {
    throw new Error('Invalid config: missing target.baseUrl')
  }

  config.output ??= {}
  config.output.inventoryPath ??= 'security/pentest/inventory.generated.json'
  config.output.checklistPath ??= 'security/pentest/checklist.generated.md'
  config.output.probeReportPath ??= 'security/pentest/probe-report.generated.json'

  config.scope ??= {}
  config.scope.includeApi ??= true
  config.scope.includeSupabase ??= true
  config.scope.includeUiModules ??= true

  config.probes ??= {}
  config.probes.enabled ??= false
  config.probes.timeoutMs ??= 8000
  config.probes.methods ??= ['GET', 'HEAD', 'OPTIONS']
  config.probes.publicAllowlist ??= ['/api/public/pricing']

  config.target.headers ??= {}
  return config
}
